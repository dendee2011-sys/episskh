<!DOCTYPE html>
<html lang="th" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ดข้อมูลระบาดวิทยา โรงพยาบาลศรีสะเกษ</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
    <!-- Tom Select for searchable dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

    <style>
        :root { font-family: 'Inter', sans-serif; }
        .ts-control { border-radius: 0.5rem; border-color: #d1d5db; }
        .dark .ts-control { background-color: #374151; border-color: #4b5563; }
        .dark .ts-dropdown { background-color: #374151; border-color: #4b5563; }
        .dark .ts-dropdown .option { color: #d1d5db; }
        .dark .ts-dropdown .active { background-color: #4f46e5; color: white; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen p-4 sm:p-8 transition-colors duration-300">
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#10b981',
                        'warning': '#f59e0b',
                        'danger': '#ef4444',
                    }
                }
            }
        }
    </script>

    <!-- HEADER -->
    <header class="mb-6">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl sm:text-4xl font-extrabold text-primary dark:text-indigo-400">
                    แดชบอร์ดติดตามสถานการณ์การระบาด โรงพยาบาลศรีสะเกษ
                </h1>
            </div>
            <!-- Dark Mode Toggle Button -->
            <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none rounded-lg text-sm p-2.5">
                <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"></path></svg>
            </button>
        </div>
        <div class="flex justify-between items-center mt-2 border-b-4 border-primary/50 pb-2">
             <p id="loadingMessage" class="text-yellow-500 font-semibold hidden items-center">
                 <svg class="inline w-4 h-4 mr-2 animate-spin" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0492C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="#f59e0b"/></svg>
                 กำลังโหลดข้อมูลจาก Google Sheet...
             </p>
             <p id="lastUpdated" class="text-sm text-gray-500 dark:text-gray-400 ml-auto"></p>
        </div>
    </header>

    <!-- Filter Controls -->
    <section id="filters" class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md mb-6 flex flex-col md:flex-row flex-wrap gap-4 md:gap-6 items-center">
        <label for="diseaseFilter" class="text-gray-600 dark:text-gray-300 font-medium whitespace-nowrap">โรค:</label>
        <select id="diseaseFilter" class="w-full md:w-auto" placeholder="เลือกโรค..."></select>
        
        <label for="provinceFilter" class="text-gray-600 dark:text-gray-300 font-medium whitespace-nowrap">จังหวัด:</label>
        <select id="provinceFilter" class="w-full md:w-auto" placeholder="เลือกจังหวัด..."></select>
        
        <label for="districtFilter" class="text-gray-600 dark:text-gray-300 font-medium whitespace-nowrap">อำเภอ:</label>
        <select id="districtFilter" class="w-full md:w-auto" placeholder="เลือกอำเภอ..."></select>

        <label for="startDate" class="text-gray-600 dark:text-gray-300 font-medium whitespace-nowrap">เริ่มต้น:</label>
        <input type="date" id="startDate" class="p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
        
        <label for="endDate" class="text-gray-600 dark:text-gray-300 font-medium whitespace-nowrap">สิ้นสุด:</label>
        <input type="date" id="endDate" class="p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
    </section>

    <!-- Navigation Tabs -->
    <nav class="flex space-x-1 mb-6 border-b border-gray-300 dark:border-gray-700">
        <button id="tab-overview" onclick="showPage('overview')" class="px-4 py-2 font-medium border-b-4 focus:outline-none">สรุปและแนวโน้ม (เวลา)</button>
        <button id="tab-profile" onclick="showPage('profile')" class="px-4 py-2 font-medium border-b-4 focus:outline-none">ข้อมูลประชากรผู้ป่วย (บุคคล)</button>
        <button id="tab-geographic" onclick="showPage('geographic')" class="px-4 py-2 font-medium border-b-4 focus:outline-none">การกระจายตัวทางภูมิศาสตร์ (สถานที่)</button>
    </nav>

    <!-- Page Content Containers -->
    <main id="dashboard-content">
        <div id="page-overview" class="page-content">
            <section id="metrics" class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border-b-4 border-primary">
                    <p class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase">ผู้ป่วยรวม (ในช่วงที่เลือก)</p>
                    <p id="totalCases" class="text-4xl font-bold mt-1 text-primary">0</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border-b-4 border-warning">
                    <p class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase">ผู้ป่วยที่กำลังรักษา</p>
                    <p id="activeCases" class="text-4xl font-bold mt-1 text-warning">0</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border-b-4 border-danger">
                    <p class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase">ผู้เสียชีวิตรวม</p>
                    <p id="totalDeaths" class="text-4xl font-bold mt-1 text-danger">0</p>
                </div>
            </section>
            <section class="grid grid-cols-1 gap-6">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4">แนวโน้มผู้ป่วยรายเดือน (ตามวันเริ่มมีอาการ)</h2>
                    <div class="h-96"><canvas id="casesTrendChart"></canvas></div>
                </div>
            </section>
        </div>
        <div id="page-profile" class="page-content hidden">
             <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4">สัดส่วนผู้ป่วยตามเพศ</h2>
                    <div class="h-96 flex items-center justify-center"><canvas id="sexDistributionChart"></canvas></div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4">ประเภทผู้ป่วย (OPD vs IPD)</h2>
                    <div class="h-96 flex items-center justify-center"><canvas id="patientTypeChart"></canvas></div>
                </div>
            </section>
            <section class="grid grid-cols-1 gap-6 mb-6">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4">สัดส่วนผู้ป่วยตามกลุ่มอายุ</h2>
                    <div class="h-96 flex items-center justify-center"><canvas id="ageDistributionChart"></canvas></div>
                </div>
            </section>
        </div>
        <div id="page-geographic" class="page-content hidden">
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                 <div id="provinceChartContainer" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4">10 จังหวัดที่มีผู้ป่วยสูงสุด</h2>
                    <div class="h-96"><canvas id="provinceChart"></canvas></div>
                </div>
                 <div id="districtChartContainer" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4">10 อำเภอที่มีผู้ป่วยสูงสุด</h2>
                    <div class="h-96"><canvas id="districtChart"></canvas></div>
                </div>
                 <div id="subDistrictChartContainer" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg lg:col-span-2">
                    <h2 class="text-xl font-semibold mb-4">10 ตำบลที่มีผู้ป่วยสูงสุด</h2>
                    <div class="h-96"><canvas id="subDistrictChart"></canvas></div>
                </div>
            </section>
        </div>
    </main>

    <script>
        const chartInstances = {};
        const selectInstances = {};
        let epidemicData = {};
        
        // --- NEW DISEASE CODE MAPPING ---
        const DISEASE_CODE_MAP = {
            "01": "อหิวาตกโรค", "02": "โรคอุจจาระร่วงเฉียบพลัน", "03": "อาหารเป็นพิษ", "05": "โรคบิดจากเชื้อชิเกลลา", "06": "โรคบิดมีตัวหรือโรคบิดจากเชื้ออะมีบา", "07": "ไข้เอนเทอริค", "08": "ไข้ไทฟอยด์หรือไข้รากสาดน้อย", "09": "ไข้พาราไทฟอยด์หรือไข้รากสาดเทียม", "10": "โรคไวรัสตับอักเสบไม่ระบุชนิด", "11": "โรคไวรัสตับอักเสบเฉียบพลัน ชนิด เอ", "12": "โรคไวรัสตับอักเสบเฉียบพลัน ชนิด บี", "13": "โรคไวรัสตับอักเสบเฉียบพลัน ชนิด ซี", "14": "โรคตาแดง", "15": "ไข้หวัดใหญ่", "16": "ไข้หัดเยอรมัน", "17": "โรคสุกใสหรือโรคอีสุกอีใส", "18": "ไข้ไม่ทราบสาเหตุ", "19": "ไข้กาฬหลังแอ่น", "20": "โรคโปลิโอ", "21": "ไข้หัดที่ไม่มีโรคแทรกซ้อน", "22": "ไข้หัดที่มีโรคแทรกซ้อน", "23": "โรคคอตีบ", "24": "โรคไอกรน", "25": "โรคบาดทะยัก", "26": "ไข้เลือดออก", "27": "ไข้เลือดออกช็อก", "28": "ไข้สมองอักเสบ", "29": "ไข้สมองอักเสบเจแปนนิส", "30": "ไข้มาลาเรีย", "31": "โรคปอดอักเสบหรือโรคปอดบวม", "35": "โรคเรื้อน", "37": "โรคซิฟิลิส, โรคซิฟิลิสแต่กำเนิด", "38": "โรคหนองใน", "39": "โรคหนองในเทียม", "40": "โรคแผลริมอ่อน", "41": "กามโรคของต่อมและท่อน้ำเหลือง", "42": "โรคพิษสุนัขบ้า หรือ โรคกลัวน้ำ", "43": "โรคเลปโตสไปโรสิส", "44": "โรคสครับไทฟัส", "45": "โรคแอนแทรกซ์", "46": "โรคทริคิโนสิส", "52": "โรคคางทูม", "53": "โรคบาดทะยักในเด็กแรกเกิด", "54": "เยื่อหุ้มสมองอักเสบที่มิได้ระบุเชื้อสาเหตุ", "55": "เยื่อหุ้มสมองอักเสบจากพยาธิ", "65": "อาการอัมพาตกล้ามเนื้ออ่อนปวกเปียกเฉียบพลัน", "66": "ไข้เดงกี", "68": "โรคลิชมาเนีย", "69": "โรคไวรัสตับอักเสบเฉียบพลัน ชนิด ดี", "70": "โรคไวรัสตับอักเสบเฉียบพลัน ชนิด อี", "71": "โรคมือเท้าปาก", "72": "โรคเมลิออยโดสิส", "74": "ไข้ดำแดง", "75": "โรคพยาธิใบไม้ตับ", "76": "โรคเท้าช้าง", "79": "โรคเริมของอวัยวะสืบพันธุ์และทวารหนัก", "80": "โรคหูดอวัยวะเพศและทวารหนัก", "82": "โรคติดเชื้อสเตร็พโตคอคคัสซูอิส", "83": "โรคบรูเซลโลสิส", "84": "ไข้ปวดข้อยุงลาย", "85": "โรคโบทูลิซึม", "87": "โรคติดเชื้อไวรัสซิกา", "90": "ไข้เอนเทอโรไวรัส", "91": "ไข้หวัดนก", "92": "โรคติดเชื้อไวรัสโคโรนา 2019", "93": "ไข้หัดเยอรมันแต่กำเนิด", "94": "โรคฝีดาษวานร", "95": "ลีเจียนแนร์", "96": "โรคติดเชื้อไวรัสอาร์เอสวี"
        };

        // Google Sheet ID
        const SHEET_ID = '2PACX-1vSjlo-2YupNe7QhUZRHRQ50oGU5bPnoCpzzi9fOifqD6ST6QWmkx_lEgI6lm2ZQWhDt9aoD30MhR5f8'; 
        const DAILY_DATA_URL = `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?output=csv`; 

        // UPDATED FALLBACK DATA to use new disease codes
        const FALLBACK_CSV_TEXT = `Date,Disease,Sex,Age,Nationality,Province,District,SubDistrict,Onset_Date,PatientType,Is_Death,Is_Recovered
01/01/24,15,ชาย,45,ไทย,10,1004,100401,30/12/23,IPD,0,0
01/01/24,26,หญิง,28,ไทย,50,5001,500108,28/12/23,OPD,0,1
02/01/24,15,ชาย,62,พม่า,20,2002,200201,01/01/24,IPD,1,0
02/01/24,26,หญิง,33,ไทย,10,1018,101802,01/01/24,OPD,0,0
03/01/24,15,ชาย,15,ไทย,83,8301,830101,02/01/24,IPD,0,0
`;
        
        const PROVINCE_CODE_TO_NAME_MAP = {"10":"กรุงเทพมหานคร","11":"สมุทรปราการ","12":"นนทบุรี","13":"ปทุมธานี","14":"พระนครศรีอยุธยา","15":"อ่างทอง","16":"ลพบุรี","17":"สิงห์บุรี","18":"ชัยนาท","19":"สระบุรี","20":"ชลบุรี","21":"ระยอง","22":"จันทบุรี","23":"ตราด","24":"ฉะเชิงเทรา","25":"ปราจีนบุรี","26":"นครนายก","27":"สระแก้ว","30":"นครราชสีมา","31":"บุรีรัมย์","32":"สุรินทร์","33":"ศรีสะเกษ","34":"อุบลราชธานี","35":"ยโสธร","36":"ชัยภูมิ","37":"อำนาจเจริญ","38":"บึงกาฬ","39":"หนองบัวลำภู","40":"ขอนแก่น","41":"อุดรธานี","42":"เลย","43":"มหาสารคาม","44":"ร้อยเอ็ด","45":"กาฬสินธุ์","46":"สกลนคร","47":"นครพนม","48":"มุกดาหาร","49":"หนองคาย","50":"เชียงใหม่","51":"ลำพูน","52":"ลำปาง","53":"อุตรดิตถ์","54":"แพร่","55":"น่าน","56":"พะเยา","57":"เชียงราย","58":"แม่ฮ่องสอน","60":"นครสวรรค์","61":"อุทัยธานี","62":"กำแพงเพชร","63":"ตาก","64":"สุโขทัย","65":"พิษณุโลก","66":"พิจิตร","67":"เพชรบูรณ์","70":"ราชบุรี","71":"กาญจนบุรี","72":"สุพรรณบุรี","73":"นครปฐม","74":"สมุทรสาคร","75":"สมุทรสงคราม","76":"เพชรบุรี","77":"ประจวบคีรีขันธ์","80":"นครศรีธรรมราช","81":"กระบี่","82":"พังงา","83":"ภูเก็ต","84":"สุราษฎร์ธานี","85":"ระนอง","86":"ชุมพร","90":"สงขลา","91":"สตูล","92":"ตรัง","93":"พัทลุง","94":"ปัตตานี","95":"ยะลา","96":"นราธิวาส"};
        const DISTRICT_CODE_TO_NAME_MAP = {"1001":"พระนคร","1002":"ดุสิต","1003":"หนองจอก","1004":"บางรัก","1005":"บางเขน","1017":"ห้วยขวาง","1018":"คลองสาน","1031":"บางคอแหลม","1036":"ดอนเมือง","1039":"วัฒนา","1101":"เมืองสมุทรปราการ","1103":"บางพลี","1201":"เมืองนนทบุรี","1202":"บางกรวย","1301":"เมืองปทุมธานี","1303":"ธัญบุรี","1401":"พระนครศรีอยุธยา","1402":"ท่าเรือ","2001":"เมืองชลบุรี","2002":"บ้านบึง","2003":"หนองใหญ่","2005":"พานทอง","2008":"เกาะสีชัง","2101":"เมืองระยอง","2102":"บ้านฉาง","3001":"เมืองนครราชสีมา","3002":"ครบุรี","3005":"บ้านเหลื่อม","3009":"โนนไทย","3012":"บัวใหญ่","3013":"ประทาย","3301":"เมืองศรีสะเกษ","3302":"ยางชุมน้อย","3303":"กันทรารมย์","3304":"กันทรลักษ์","3305":"ขุขันธ์","3306":"ไพรบึง","3307":"ปรางค์กู่","3308":"ขุนหาญ","3309":"ราษีไศล","3310":"อุทุมพรพิสัย","3311":"บึงบูรพ์","3312":"ห้วยทับทัน","3313":"โนนคูณ","3314":"ศรีรัตนะ","3315":"น้ำเกลี้ยง","3316":"วังหิน","3317":"ภูสิงห์","3318":"เมืองจันทร์","3319":"เบญจลักษ์","3320":"พยุห์","3321":"โพธิ์ศรีสุวรรณ","3322":"ศิลาลาด","3401":"เมืองอุบลราชธานี","3402":"ศรีเมืองใหม่","4001":"เมืองขอนแก่น","4002":"บ้านไผ่","4101":"เมืองอุดรธานี","4301":"เมืองมหาสารคาม","4401":"เมืองร้อยเอ็ด","4501":"เมืองกาฬสินธุ์","5001":"เมืองเชียงใหม่","5002":"จอมทอง","5005":"ดอยสะเก็ด","5006":"แม่แตง","5301":"เมืองอุตรดิตถ์","5701":"เมืองเชียงราย","6501":"เมืองพิษณุโลก","6701":"เมืองเพชรบูรณ์","8301":"เมืองภูเก็ต","8302":"กะทู้","8303":"ถลาง","9001":"เมืองสงขลา","9005":"เทพา","9011":"หาดใหญ่","3601":"เมืองชัยภูมิ","3603":"คอนสวรรค์","3610":"ภูเขียว"};
        const SUBDISTRICT_CODE_TO_NAME_MAP = {"330101":"เมืองเหนือ","330102":"เมืองใต้","330103":"คูซอด","330104":"ซำ","330105":"จาน","330106":"ตะดอบ","330107":"หนองครก","330111":"โพนข่า","330112":"โพนค้อ","330115":"โพนเขวา","330116":"หญ้าปล้อง","330118":"ทุ่ม","330119":"หนองไฮ","330121":"หนองแก้ว","330122":"น้ำคำ","330123":"โพธิ์","330124":"หมากเขียบ","330127":"หนองไผ่","330100":"ไม่ทราบที่อยู่","330108":"ไม่ทราบที่อยู่","330109":"ไม่ทราบที่อยู่","330110":"ไม่ทราบที่อยู่","330113":"ไม่ทราบที่อยู่","330114":"ไม่ทราบที่อยู่","330125":"ไม่ทราบที่อยู่","100401":"สามเสนใน","101701":"ห้วยขวาง","101802":"หัวหมาก","103101":"ดินแดง","103601":"สีกัน","103901":"บางนาเหนือ","120101":"ตลาดขวัญ","130303":"ลำผักกูด","140101":"ประตูชัย","200104":"บ้านสวน","200201":"หนองปรือ","200507":"นาจอมเทียน","200801":"ศรีราชา","210103":"มาบตาพุด","300101":"ในเมือง (โคราช)","300503":"ใหม่","300901":"ในเมือง (พิมาย)","301207":"กลางดง","500108":"สุเทพ","500109":"ช้างคลาน","500502":"หนองหาร","500602":"ริมใต้","830101":"ตลาดใหญ่","830202":"ป่าตอง","830301":"เทพกระษัตรี","900501":"ทำเนียบ","901103":"ควนลัง","100101":"พระบรมมหาราชวัง","100201":"ดุสิต","100301":"กระทุ่มราย","110101":"ปากน้ำ","110102":"สำโรงเหนือ","120201":"วัดชลอ","130101":"บางปรอก","130301":"ประชาธิปัตย์","150101":"ตลาดหลวง","160101":"ทะเลชุบศร","170101":"บางพุทรา","180101":"ในเมือง (ชัยนาท)","190101":"ปากเพรียว","200101":"บางปลาสร้อย","220101":"ตลาด","230101":"บางพระ","240101":"หน้าเมือง","250101":"หน้าเมือง","260101":"นครนายก","270101":"สระแก้ว","310101":"ในเมือง (บุรีรัมย์)","320101":"ในเมือง (สุรินทร์)","340101":"ในเมือง (อุบลฯ)","350101":"ในเมือง (ยโสธร)","360101":"ในเมือง (ชัยภูมิ)","370101":"บุ่ง (อ.เจริญ)","400101":"ในเมือง (ขอนแก่น)","410101":"หมากแข้ง","420101":"กุดป่อง","430101":"ในเมือง (หนองคาย)","440101":"ตลาด (มค.)","450101":"ในเมือง (ร้อยเอ็ด)","460101":"กาฬสินธุ์","470101":"ธาตุเชิงชุม","480101":"ในเมือง (นพ.)","490101":"มุกดาหาร","500101":"ศรีภูมิ","510101":"ในเมือง (ลำพูน)","520101":"เวียงเหนือ","530101":"ท่าอิฐ","540101":"ในเวียง","550101":"ในเวียง","560101":"เวียง (พะเยา)","570101":"เวียง (ชร.)","580101":"จองคำ","600101":"ปากน้ำโพ","610101":"อุทัยใหม่","620101":"ในเมือง (กพ.)","630101":"ระแหง","640101":"ธานี","650101":"ในเมือง (พล.)","660101":"ในเมือง (พิจิตร)","670101":"ในเมือง (พช.)","700101":"หน้าเมือง","710101":"บ้านเหนือ","720101":"ท่าพี่เลี้ยง","730101":"พระปฐมเจดีย์","740101":"มหาชัย","750101":"แม่กลอง","760101":"ท่าราบ","770101":"ประจวบคีรีขันธ์","800101":"ในเมือง (นศ.)","810101":"ปากน้ำ","820101":"ท้ายช้าง","830101":"ตลาดใหญ","840101":"ตลาด (สฎ.)","850101":"เขานิเวศน์","860101":"ท่าตะเภา","900101":"บ่อยาง","910101":"พิมาน","920101":"ทับเที่ยง","930101":"คูหาสวรรค์","940101":"สะบารัง","950101":"สะเตง","960101":"บางนาค"};
        
        // --- DATA PROCESSING FUNCTIONS ---

        /**
         * Converts a disease code from the new system to its Thai name.
         */
        function classifyDiseaseCode(diseaseCode) {
            if (!diseaseCode) return 'ไม่ระบุ';
            const code = diseaseCode.trim();
            return DISEASE_CODE_MAP[code] || `รหัส: ${code} (อื่นๆ)`;
        }

        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) return [];
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim());
                let obj = {};
                headers.forEach((header, i) => obj[header.replace(/\s/g, '_')] = values[i]);
                return obj;
            });
        }
        
        function parseDate(dateString) {
            if (!dateString) return null;
            const parts = dateString.split(/[\/\-]/);
            if (parts.length === 3) {
                let [day, month, year] = parts;
                if (year.length === 2) year = (parseInt(year, 10) < 50 ? '20' : '19') + year;
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            return dateString;
        }

        function classifyAge(age) {
            const ageNum = parseInt(age);
            if (isNaN(ageNum) || ageNum < 0) return 'ไม่ระบุ';
            if (ageNum <= 10) return '0-10 ปี';
            if (ageNum <= 20) return '11-20 ปี';
            if (ageNum <= 30) return '21-30 ปี';
            if (ageNum <= 40) return '31-40 ปี';
            if (ageNum <= 50) return '41-50 ปี';
            if (ageNum <= 60) return '51-60 ปี';
            if (ageNum <= 70) return '61-70 ปี';
            return '71 ปีขึ้นไป';
        }

        function standardizeGeoData(lineList) {
            return lineList.map(item => {
                const convert = (raw, map, len) => {
                    const code = (raw || '').trim();
                    if (code && !isNaN(code)) {
                        const displayName = map[code.padStart(len, '0').slice(-len)];
                        return { code, displayName: displayName || `รหัส: ${code}` };
                    }
                    return { code: '0'.repeat(len), displayName: raw || 'ไม่ระบุ' };
                };
                let p = convert(item.province, PROVINCE_CODE_TO_NAME_MAP, 2);
                item.provinceCode = p.code;
                item.provinceDisplay = p.displayName;
                let dCode = (item.district || '').trim();
                if (dCode.length === 2) dCode = p.code + dCode;
                let d = convert(dCode, DISTRICT_CODE_TO_NAME_MAP, 4);
                item.districtCode = d.code;
                item.districtDisplay = d.displayName;
                let sdCode = (item.subDistrict || '').trim();
                if (sdCode.length === 2) sdCode = d.code + sdCode;
                let sd = convert(sdCode, SUBDISTRICT_CODE_TO_NAME_MAP, 6);
                item.subDistrictCode = sd.code;
                item.subDistrictDisplay = sd.displayName;
                return item;
            });
        }

        async function fetchEpidemicData() {
            let csvText = FALLBACK_CSV_TEXT;
            document.getElementById('loadingMessage').classList.remove('hidden');
            try {
                let response;
                for (let i = 0; i < 3; i++) {
                    try {
                        response = await fetch(DAILY_DATA_URL);
                        if (response.ok) break;
                    } catch (e) {}
                    if (i < 2) await new Promise(r => setTimeout(r, 2**i * 1000));
                }
                if (response && response.ok) csvText = await response.text();
                else console.warn(`Fetch failed. Using fallback data.`);
            } catch (err) {
                console.error("Network error:", err);
            } finally {
                document.getElementById('loadingMessage').classList.add('hidden');
            }

            try {
                const caseLineList = parseCSV(csvText);
                let formattedData = caseLineList.map(row => ({
                    reportDate: parseDate(row.Date),
                    diseaseCode: row.Disease || 'ไม่ระบุ',
                    diseaseGroup: classifyDiseaseCode(row.Disease),
                    sex: row.Sex || 'ไม่ระบุ',
                    ageGroup: classifyAge(row.Age),
                    nationality: row.Nationality || 'ไม่ระบุ',
                    province: row.Province, district: row.District, subDistrict: row.SubDistrict,
                    onsetDate: parseDate(row.Onset_Date),
                    patientType: row.PatientType || 'ไม่ระบุ',
                    isDeath: parseInt(row.Is_Death) || 0,
                    isRecovered: parseInt(row.Is_Recovered) || 0,
                })).filter(item => item.reportDate);
                
                return standardizeGeoData(formattedData);
            } catch (err) {
                console.error("Data processing error:", err);
                return [];
            }
        }

        // --- FILTERING AND METRICS ---

        function filterData(data, start, end, disease, province, district) {
            if (!data) return [];
            const startDate = new Date(start);
            const endDate = new Date(end);
            return data.filter(item => {
                const itemDate = new Date(item.reportDate);
                return itemDate >= startDate && itemDate <= endDate &&
                    (disease === 'ทั้งหมด' || item.diseaseGroup === disease) &&
                    (province === 'ทั้งหมด' || item.provinceDisplay === province) &&
                    (district === 'ทั้งหมด' || item.districtDisplay === district);
            });
        }
        
        function populateProvinceFilters(data) {
            const provinces = [...new Set(data.map(i => i.provinceDisplay))].filter(Boolean).sort();
            selectInstances.province.clearOptions();
            selectInstances.province.addOption({value: 'ทั้งหมด', text: 'ทั้งหมด (All Provinces)'});
            provinces.forEach(p => selectInstances.province.addOption({value: p, text: p}));
            selectInstances.province.setValue('ทั้งหมด');
            populateDistrictFilters(data); 
        }

        function populateDistrictFilters(data) {
            const prov = selectInstances.province.getValue();
            let districts = [];
            if (prov !== 'ทั้งหมด') {
                districts = [...new Set(data.filter(i => i.provinceDisplay === prov).map(i => i.districtDisplay))].filter(Boolean).sort();
            }
            selectInstances.district.clear();
            selectInstances.district.addOption({value: 'ทั้งหมด', text: 'ทั้งหมด (All Districts)'});
            districts.forEach(d => selectInstances.district.addOption({value: d, text: d}));
            selectInstances.district.setValue('ทั้งหมด');
        }

        function calculateAndUpdateMetrics(data) {
            const total = data.length;
            const deaths = data.reduce((s, i) => s + i.isDeath, 0);
            const recovered = data.reduce((s, i) => s + i.isRecovered, 0);
            document.getElementById('totalCases').textContent = total.toLocaleString();
            document.getElementById('activeCases').textContent = (total - deaths - recovered).toLocaleString();
            document.getElementById('totalDeaths').textContent = deaths.toLocaleString();
        }
        
        // --- CHART CREATION ---

        function destroyChart(id) {
            if (chartInstances[id]) chartInstances[id].destroy();
        }
        
        function createChart(id, config) {
            destroyChart(id);
            chartInstances[id] = new Chart(document.getElementById(id).getContext('2d'), config);
        }

        function createProvinceChart(data) {
            const counts = data.reduce((acc, {provinceDisplay: p}) => (acc[p] = (acc[p] || 0) + 1, acc), {});
            const sorted = Object.entries(counts).filter(([n]) => n !== 'ไม่ระบุ').sort(([,a],[,b]) => b - a).slice(0, 10);
            createChart('provinceChart', {
                type: 'bar',
                data: { labels: sorted.map(([n]) => n), datasets: [{ label: 'ผู้ป่วย', data: sorted.map(([,c]) => c), backgroundColor: '#10b981' }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }
        
        function createDistrictChart(data) {
            const counts = data.reduce((acc, {districtDisplay: d}) => (acc[d] = (acc[d] || 0) + 1, acc), {});
            const sorted = Object.entries(counts).filter(([n]) => n !== 'ไม่ระบุ').sort(([,a],[,b]) => b - a).slice(0, 10);
            const prov = selectInstances.province.getValue();
            document.getElementById('districtChartContainer').querySelector('h2').textContent = prov !== 'ทั้งหมด' ? `10 อำเภอสูงสุด (จ.${prov})` : '10 อำเภอที่มีผู้ป่วยสูงสุด';
            createChart('districtChart', {
                type: 'bar',
                data: { labels: sorted.map(([n]) => n), datasets: [{ label: 'ผู้ป่วย', data: sorted.map(([,c]) => c), backgroundColor: '#4f46e5' }] },
                options: { indexAxis: prov !== 'ทั้งหมด' ? 'x' : 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }
        
        function createCasesTrendChart(data) {
            const yearlyData = data.reduce((acc, {onsetDate}) => {
                if (!onsetDate) return acc;
                const d = new Date(onsetDate), y = d.getFullYear(), m = d.getMonth();
                if (!acc[y]) acc[y] = Array(12).fill(0);
                acc[y][m]++;
                return acc;
            }, {});
            const colors = ['#4f46e5', '#ef4444', '#10b981', '#f59e0b', '#6b21a8', '#db2777'];
            const datasets = Object.keys(yearlyData).sort().map((y, i) => ({
                label: `พ.ศ. ${parseInt(y) + 543}`,
                data: yearlyData[y],
                borderColor: colors[i % colors.length],
                tension: 0.4
            }));
            createChart('casesTrendChart', {
                type: 'line',
                data: { labels: ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."], datasets },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } } }
            });
        }

        function createAgeDistributionChart(data) {
            const counts = data.reduce((acc, {ageGroup: a}) => (acc[a] = (acc[a] || 0) + 1, acc), {});
            const order = ['0-10 ปี', '11-20 ปี', '21-30 ปี', '31-40 ปี', '41-50 ปี', '51-60 ปี', '61-70 ปี', '71 ปีขึ้นไป', 'ไม่ระบุ'];
            const sorted = Object.entries(counts).sort(([a], [b]) => order.indexOf(a) - order.indexOf(b));
            createChart('ageDistributionChart', {
                type: 'bar',
                data: { labels: sorted.map(([n]) => n), datasets: [{ label: 'ผู้ป่วย', data: sorted.map(([,c]) => c), backgroundColor: '#f59e0b' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function createSexDistributionChart(data) {
            const counts = data.reduce((acc, {sex: s}) => (acc[s] = (acc[s] || 0) + 1, acc), {});
            createChart('sexDistributionChart', {
                type: 'doughnut',
                data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: ['#4f46e5', '#ef4444', '#94a3b8'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        }

        function createSubDistrictChart(data) {
            const counts = data.reduce((acc, {subDistrictDisplay: s}) => (acc[s] = (acc[s] || 0) + 1, acc), {});
            const prov = selectInstances.province.getValue(), dist = selectInstances.district.getValue();
            const titleEl = document.getElementById('subDistrictChartContainer').querySelector('h2');
            let sorted;
            if (dist !== 'ทั้งหมด') {
                titleEl.textContent = `จำนวนผู้ป่วยรายตำบล (อ.${dist})`;
                sorted = Object.entries(counts).filter(([n]) => n !== 'ไม่ระบุ').sort(([a],[b]) => a.localeCompare(b, 'th'));
            } else {
                const title = prov !== 'ทั้งหมด' ? `10 ตำบลสูงสุด (จ.${prov})` : '10 ตำบลที่มีผู้ป่วยสูงสุด';
                titleEl.textContent = title;
                sorted = Object.entries(counts).filter(([n]) => n !== 'ไม่ระบุ').sort(([,a],[,b]) => b - a).slice(0, 10);
            }
            createChart('subDistrictChart', {
                type: 'bar',
                data: { labels: sorted.map(([n]) => n), datasets: [{ label: 'ผู้ป่วย', data: sorted.map(([,c]) => c), backgroundColor: '#ef4444' }] },
                options: { indexAxis: 'x', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function createPatientTypeChart(data) {
            const counts = data.reduce((acc, {patientType: p}) => (acc[p] = (acc[p] || 0) + 1, acc), {});
            createChart('patientTypeChart', {
                type: 'pie',
                data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: ['#10b981', '#4f46e5', '#94a3b8'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        }

        // --- UI AND APP LOGIC ---

        let currentPage = 'overview';
        function showPage(pageId) {
            currentPage = pageId;
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(t => t.className = 'px-4 py-2 font-medium border-b-4 border-transparent text-gray-600 dark:text-gray-400 hover:border-primary/50 focus:outline-none');
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            document.getElementById(`tab-${pageId}`).className = 'px-4 py-2 font-medium border-b-4 border-primary text-primary dark:border-indigo-400 focus:outline-none';
            renderDashboard();
        }

        function renderDashboard() {
            const filteredData = filterData(epidemicData, $('#startDate').value, $('#endDate').value, selectInstances.disease.getValue(), selectInstances.province.getValue(), selectInstances.district.getValue());
            calculateAndUpdateMetrics(filteredData);
            ['casesTrend', 'ageDistribution', 'sexDistribution', 'patientType', 'province', 'district', 'subDistrict'].forEach(c => this[`create${c.charAt(0).toUpperCase() + c.slice(1)}Chart`](filteredData));
            
            const provContainer = $('#provinceChartContainer'), distContainer = $('#districtChartContainer'), subDistContainer = $('#subDistrictChartContainer');
            const selProv = selectInstances.province.getValue(), selDist = selectInstances.district.getValue();

            if (currentPage === 'geographic') {
                if (selDist !== 'ทั้งหมด') {
                    provContainer.classList.add('hidden');
                    distContainer.classList.add('hidden');
                    subDistContainer.classList.remove('hidden', 'lg:col-span-2');
                    subDistContainer.classList.add('lg:col-span-2');
                } else if (selProv !== 'ทั้งหมด') {
                    provContainer.classList.add('hidden');
                    distContainer.classList.remove('hidden');
                    subDistContainer.classList.remove('hidden', 'lg:col-span-2');
                } else {
                    provContainer.classList.remove('hidden');
                    distContainer.classList.remove('hidden');
                    subDistContainer.classList.remove('hidden');
                    subDistContainer.classList.add('lg:col-span-2');
                }
            } else {
                [provContainer, distContainer].forEach(c => c.classList.remove('hidden'));
                subDistContainer.classList.add('lg:col-span-2');
            }
            $('#lastUpdated').textContent = 'อัปเดตล่าสุด: ' + new Date().toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'short' });
        }
        
        const $ = (selector) => document.querySelector(selector);

        window.onload = async function() {
            const tomSelectSettings = { create: false, sortField: { field: "text", direction: "asc" } };
            selectInstances.disease = new TomSelect('#diseaseFilter', tomSelectSettings);
            selectInstances.province = new TomSelect('#provinceFilter', tomSelectSettings);
            selectInstances.district = new TomSelect('#districtFilter', tomSelectSettings);

            epidemicData = await fetchEpidemicData();
            if (!epidemicData || epidemicData.length === 0) console.error("Could not load data.");

            const dates = epidemicData.map(i => i.reportDate).filter(Boolean).sort();
            $('#startDate').value = dates[0] || new Date().toISOString().split('T')[0];
            $('#endDate').value = dates.pop() || new Date().toISOString().split('T')[0];

            const diseases = [...new Set(epidemicData.map(i => i.diseaseGroup))].filter(Boolean).sort();
            selectInstances.disease.clearOptions();
            selectInstances.disease.addOption({value: 'ทั้งหมด', text: 'ทั้งหมด (All Diseases)'});
            diseases.forEach(d => selectInstances.disease.addOption({value: d, text: d}));
            selectInstances.disease.setValue('ทั้งหมด');

            populateProvinceFilters(epidemicData);
            
            const filterChangeHandler = () => renderDashboard();
            $('#startDate').addEventListener('change', filterChangeHandler);
            $('#endDate').addEventListener('change', filterChangeHandler);
            selectInstances.disease.on('change', filterChangeHandler);
            selectInstances.district.on('change', filterChangeHandler);
            selectInstances.province.on('change', () => {
                populateDistrictFilters(epidemicData);
                renderDashboard();
            });

            const themeToggle = $('#theme-toggle'), darkIcon = $('#theme-toggle-dark-icon'), lightIcon = $('#theme-toggle-light-icon');
            const updateIcons = () => {
                const isDark = document.documentElement.classList.contains('dark');
                darkIcon.classList.toggle('hidden', isDark);
                lightIcon.classList.toggle('hidden', !isDark);
            };
            themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('theme', isDark ? 'light' : 'dark');
                document.documentElement.classList.toggle('dark');
                updateIcons();
                renderDashboard();
            });
            updateIcons();
            
            showPage('overview');
        };
    </script>
</body>
</html>
