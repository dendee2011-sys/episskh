<!DOCTYPE html>
<html lang="th" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ดข้อมูลระบาดวิทยา โรงพยาบาลศรีสะเกษ</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
    <!-- NEW: Tom Select for searchable dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

    <style>
        /* ตั้งค่าฟอนต์หลักเป็น Inter (สำหรับภาษาอังกฤษ) และใช้ Sans-serif สำหรับภาษาไทย */
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for Tom Select to match the dashboard's dark mode */
        .ts-control {
            border-radius: 0.5rem;
            border-color: #d1d5db; /* gray-300 */
        }
        .dark .ts-control {
            background-color: #374151; /* gray-700 */
            border-color: #4b5563; /* gray-600 */
        }
        .dark .ts-dropdown {
             background-color: #374151; /* gray-700 */
             border-color: #4b5563; /* gray-600 */
        }
        .dark .ts-dropdown .option {
            color: #d1d5db; /* gray-300 */
        }
        .dark .ts-dropdown .active {
            background-color: #4f46e5; /* primary */
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen p-4 sm:p-8 transition-colors duration-300">
    <!-- Script to prevent Flash of Unstyled Content (FOUC) for dark mode -->
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    <script>
        // Tailwind dark mode configuration
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#10b981',
                        'warning': '#f59e0b',
                        'danger': '#ef4444',
                    }
                }
            }
        }
    </script>

    <!-- HEADER -->
    <header class="mb-6">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl sm:text-4xl font-extrabold text-primary dark:text-indigo-400">
                    แดชบอร์ดติดตามสถานการณ์การระบาด โรงพยาบาลศรีสะเกษ
                </h1>
                <p class="text-gray-500 dark:text-gray-400 mt-1">
                
                </p>
            </div>
            <!-- Dark Mode Toggle Button -->
            <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
                <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
            </button>
        </div>
        <div class="flex justify-between items-center mt-2 border-b-4 border-primary/50 pb-2">
             <!-- Loading Indicator -->
             <p id="loadingMessage" class="text-yellow-500 font-semibold hidden items-center">
                 <svg class="inline w-4 h-4 mr-2 animate-spin" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                    <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0492C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="#f59e0b"/>
                 </svg>
                 กำลังโหลดข้อมูลจาก Google Sheet...
             </p>
             <!-- Last Updated Timestamp -->
             <p id="lastUpdated" class="text-sm text-gray-500 dark:text-gray-400 ml-auto"></p>
        </div>
    </header>

    <!-- Filter Controls -->
    <section id="filters" class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md mb-6 flex flex-col md:flex-row flex-wrap gap-4 md:gap-6 items-center">
        <!-- Disease Filter -->
        <label for="diseaseFilter" class="text-gray-600 dark:text-gray-300 font-medium whitespace-nowrap">โรค:</label>
        <select id="diseaseFilter" class="w-full md:w-auto" placeholder="เลือกโรค..."></select>
        
        <!-- Province Filter -->
        <label for="provinceFilter" class="text-gray-600 dark:text-gray-300 font-medium whitespace-nowrap">จังหวัด:</label>
        <select id="provinceFilter" class="w-full md:w-auto" placeholder="เลือกจังหวัด..."></select>
        
        <!-- District Filter -->
        <label for="districtFilter" class="text-gray-600 dark:text-gray-300 font-medium whitespace-nowrap">อำเภอ:</label>
        <select id="districtFilter" class="w-full md:w-auto" placeholder="เลือกอำเภอ..."></select>

        <!-- Date Filters -->
        <label for="startDate" class="text-gray-600 dark:text-gray-300 font-medium whitespace-nowrap">เริ่มต้น:</label>
        <input type="date" id="startDate" class="p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:ring-primary focus:border-primary flex-grow md:flex-grow-0">
        
        <label for="endDate" class="text-gray-600 dark:text-gray-300 font-medium whitespace-nowrap">สิ้นสุด:</label>
        <input type="date" id="endDate" class="p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:ring-primary focus:border-primary flex-grow md:flex-grow-0">
    </section>

    <!-- Navigation Tabs -->
    <nav class="flex space-x-1 mb-6 border-b border-gray-300 dark:border-gray-700">
        <button id="tab-overview" onclick="showPage('overview')" class="px-4 py-2 text-sm sm:text-base font-medium border-b-4 border-primary text-primary dark:text-indigo-400 dark:border-indigo-400 focus:outline-none transition duration-150 ease-in-out">
            สรุปและแนวโน้ม (เวลา)
        </button>
        <button id="tab-profile" onclick="showPage('profile')" class="px-4 py-2 text-sm sm:text-base font-medium border-b-4 border-transparent text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-indigo-400 hover:border-primary/50 focus:outline-none transition duration-150 ease-in-out">
            ข้อมูลประชากรผู้ป่วย (บุคคล)
        </button>
        <button id="tab-geographic" onclick="showPage('geographic')" class="px-4 py-2 text-sm sm:text-base font-medium border-b-4 border-transparent text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-indigo-400 hover:border-primary/50 focus:outline-none transition duration-150 ease-in-out">
            การกระจายตัวทางภูมิศาสตร์ (สถานที่)
        </button>
    </nav>

    <!-- Page Content Containers -->
    <main id="dashboard-content">
        
        <!-- ============================================================================== -->
        <!-- PAGE 1: OVERVIEW & TREND (สรุปและแนวโน้ม - เวลา) -->
        <!-- ============================================================================== -->
        <div id="page-overview" class="page-content">
            
            <!-- Key Metrics Cards -->
            <section id="metrics" class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
                <!-- Card 1: Total Cases -->
                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg transition duration-300 border-b-4 border-primary">
                    <p class="text-xs sm:text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase">ผู้ป่วยรวมทั้งหมด (ในช่วงที่เลือก)</p>
                    <p id="totalCases" class="text-3xl sm:text-4xl font-bold mt-1 text-primary">0</p>
                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">ยอดสะสม</p>
                </div>

                <!-- Card 2: Active Cases -->
                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg transition duration-300 border-b-4 border-warning">
                    <p class="text-xs sm:text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase">ผู้ป่วยที่กำลังรักษา</p>
                    <p id="activeCases" class="text-3xl sm:text-4xl font-bold mt-1 text-warning">0</p>
                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">จำนวนผู้ป่วยปัจจุบัน</p>
                </div>

                <!-- Card 3: Total Deaths -->
                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg transition duration-300 border-b-4 border-danger">
                    <p class="text-xs sm:text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase">ผู้เสียชีวิตรวม</p>
                    <p id="totalDeaths" class="text-3xl sm:text-4xl font-bold mt-1 text-danger">0</p>
                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">ยอดรวมทั้งหมด</p>
                </div>

            </section>
            
            <!-- Chart 1: Daily Cases Trend (Time) -->
            <section class="grid grid-cols-1 gap-6">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">แนวโน้มผู้ป่วยรายเดือน (ตามวันเริ่มมีอาการ)</h2>
                    <div class="h-80 lg:h-96">
                        <canvas id="casesTrendChart"></canvas>
                    </div>
                </div>
            </section>
        </div>

        <!-- ============================================================================== -->
        <!-- PAGE 2: PATIENT PROFILE (ข้อมูลประชากรผู้ป่วย - บุคคล) -->
        <!-- ============================================================================== -->
        <div id="page-profile" class="page-content hidden">
             <!-- Top Row: Sex and Patient Type -->
             <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Chart: Sex Distribution -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">สัดส่วนผู้ป่วยตามเพศ</h2>
                    <div class="h-80 lg:h-96 flex items-center justify-center">
                        <canvas id="sexDistributionChart"></canvas>
                    </div>
                </div>

                 <!-- Chart 4: Patient Type (OPD/IPD) -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">ประเภทผู้ป่วย (OPD vs IPD)</h2>
                    <div class="h-80 lg:h-96 flex items-center justify-center">
                        <canvas id="patientTypeChart"></canvas>
                    </div>
                </div>
            </section>
            
            <!-- Bottom Row: Age Distribution (Full Width) -->
            <section class="grid grid-cols-1 gap-6 mb-6">
                <!-- Chart 2: Age Distribution -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">สัดส่วนผู้ป่วยตามกลุ่มอายุ</h2>
                    <div class="h-80 lg:h-96 flex items-center justify-center">
                        <canvas id="ageDistributionChart"></canvas>
                    </div>
                </div>
            </section>
        </div>

        <!-- ============================================================================== -->
        <!-- PAGE 3: GEOGRAPHIC DISTRIBUTION (การกระจายตัวทางภูมิศาสตร์ - สถานที่) -->
        <!-- ============================================================================== -->
        <div id="page-geographic" class="page-content hidden">
            <!-- UPDATED: All geo charts are now in a single grid container for dynamic layout -->
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                
                 <!-- Chart 1: Province Distribution -->
                 <div id="provinceChartContainer" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">10 จังหวัดที่มีผู้ป่วยสูงสุด</h2>
                    <div class="h-80 lg:h-96">
                        <canvas id="provinceChart"></canvas>
                    </div>
                </div>

                 <!-- Chart: District Distribution -->
                 <div id="districtChartContainer" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">10 อำเภอที่มีผู้ป่วยสูงสุด</h2>
                    <div class="h-80 lg:h-96">
                        <canvas id="districtChart"></canvas>
                    </div>
                </div>

                 <!-- Chart 3: SubDistrict Distribution -->
                 <div id="subDistrictChartContainer" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg lg:col-span-2">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">10 ตำบลที่มีผู้ป่วยสูงสุด</h2>
                    <div class="h-80 lg:h-96">
                        <canvas id="subDistrictChart"></canvas>
                    </div>
                </div>
            </section>
        </div>
        
    </main>

    <!-- JavaScript for Data Handling and Chart Rendering -->
    <script>
        const chartInstances = {};
        const selectInstances = {}; // NEW: To hold Tom Select instances
        let epidemicData = {}; // Global variable for the full Case Line List data
        
        // --- DATA MAPPING AND FALLBACK ---
        
        // Google Sheet ID
        const SHEET_ID = '2PACX-1vSjlo-2YupNe7QhUZRHRQ50oGU5bPnoCpzzi9fOifqD6ST6QWmkx_lEgI6lm2ZQWhDt9aoD30MhR5f8'; 
        
        // URL to fetch published Google Sheet as CSV
        const DAILY_DATA_URL = `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?output=csv`; 

        // Fallback data (used only if fetching the live Google Sheet fails)
        const FALLBACK_CSV_TEXT = `Date,Disease,ICD_Code,Sex,Age,Nationality,Province,District,SubDistrict,Onset_Date,PatientType,Is_Death,Is_Recovered
01/01/24,ไข้หวัดใหญ่,J10,ชาย,45,ไทย,10,1004,100401,30/12/23,IPD,0,0
01/01/24,ไข้เลือดออก,A91,หญิง,28,ไทย,50,5001,500108,28/12/23,OPD,0,1
02/01/24,ไข้หวัดใหญ่,J10,ชาย,62,พม่า,20,2002,200201,01/01/24,IPD,1,0
02/01/24,ไข้เลือดออก,A91,หญิง,33,ไทย,10,1018,101802,01/01/24,OPD,0,0
03/01/24,ไข้หวัดใหญ่,J10,ชาย,15,ไทย,83,8301,830101,02/01/24,IPD,0,0
03/01/24,ไข้หวัดใหญ่,J10,หญิง,55,ลาว,50,5005,500502,01/01/24,OPD,0,1
04/01/24,ไข้เลือดออก,A91,ชาย,23,ไทย,20,05,07,03/01/24,OPD,0,0
04/01/24,ไข้หวัดใหญ่,J10,หญิง,75,ไทย,30,3001,300101,01/01/24,IPD,1,0
05/01/24,ไข้หวัดใหญ่,J10,ชาย,39,ไทย,90,9011,901103,04/01/24,OPD,0,0
05/01/24,ไข้เลือดออก,A91,หญิง,5,ไทย,10,1039,01,03/01/24,IPD,0,0
06/01/24,ไข้หวัดใหญ่,J10,ชาย,48,ไทย,50,5001,09,05/01/24,OPD,0,1
06/01/24,ไข้เลือดออก,A91,หญิง,68,ไทย,20,2001,04,04/01/24,IPD,0,0
07/01/24,ไข้หวัดใหญ่,J10,ชาย,29,ไทย,83,8302,02,06/01/24,OPD,0,1
07/01/24,ไข้เลือดออก,A91,หญิง,35,ไทย,30,3012,07,05/01/24,IPD,0,0
08/01/24,ไข้หวัดใหญ่,J10,ชาย,18,ไทย,10,1031,01,07/01/24,OPD,0,1
08/01/24,ไข้เลือดออก,A91,หญิง,52,กัมพูชา,90,9005,01,06/01/24,IPD,0,0
09/01/24,ไข้หวัดใหญ่,J10,ชาย,44,ไทย,40,4001,01,08/01/24,OPD,0,0
09/01/24,ไข้เลือดออก,A91,หญิง,24,ไทย,10,1017,01,07/01/24,OPD,0,1
10/01/24,ไข้หวัดใหญ่,J10,ชาย,67,ไทย,21,2101,03,09/01/24,IPD,0,0
10/01/24,ไข้เลือดออก,A91,หญิง,32,ไทย,30,3005,03,08/01/24,OPD,0,1
11/01/24,ไข้หวัดใหญ่,J10,ชาย,16,ไทย,14,1401,01,10/01/24,IPD,0,0
11/01/24,ไข้เลือดออก,A91,หญิง,58,ไทย,12,1201,01,09/01/24,OPD,0,1
12/01/24,ไข้หวัดใหญ่,J10,ชาย,43,ไทย,13,1303,03,10/01/24,IPD,0,0
12/01/24,ไข้เลือดออก,A91,หญิง,25,ไทย,20,08,01,11/01/24,OPD,0,1
13/01/24,ไข้หวัดใหญ่,J10,ชาย,69,ไทย,10,1036,01,12/01/24,IPD,0,0
13/01/24,ไข้เลือดออก,A91,หญิง,36,ไทย,50,5006,02,11/01/24,OPD,0,1
14/01/24,ไข้หวัดใหญ่,J10,ชาย,17,ไทย,83,8303,01,13/01/24,IPD,0,0
14/01/24,ไข้เลือดออก,A91,หญิง,53,ไทย,30,3009,01,12/01/24,OPD,0,1
15/01/24,ไข้หวัดใหญ่,J10,ชาย,22,ไทย,33,01,01,14/01/24,IPD,0,0
15/01/24,ไข้เลือดออก,A91,หญิง,34,ไทย,33,02,02,14/01/24,OPD,0,1
`;
        
        /**
         * ICD-10 Code Grouping Table
         * Groups 3-digit ICD-10 codes into major disease categories.
         */
        const ICD_CODE_GROUPING = {
            // --- โรคระบบทางเดินอาหาร ---
            "A020": "อาหารเป็นพิษ",
            "A021": "อาหารเป็นพิษ",
            "A022": "อาหารเป็นพิษ",
            "A029": "อาหารเป็นพิษ",
            "A050": "อาหารเป็นพิษ",
            "A052": "อาหารเป็นพิษ",
            "A053": "อาหารเป็นพิษ",
            "A054": "อาหารเป็นพิษ",
            "A058": "อาหารเป็นพิษ",
            "A059": "อาหารเป็นพิษ",
            "A329": "อาหารเป็นพิษ",

            "A040": "โรคอุจจาระร่วงเฉียบพลัน",
            "A044": "โรคอุจจาระร่วงเฉียบพลัน",
            "A047": "โรคอุจจาระร่วงเฉียบพลัน",
            "A048": "โรคอุจจาระร่วงเฉียบพลัน",
            "A049": "โรคอุจจาระร่วงเฉียบพลัน",
            "A080": "โรคอุจจาระร่วงเฉียบพลัน",
            "A081": "โรคอุจจาระร่วงเฉียบพลัน",
            "A082": "โรคอุจจาระร่วงเฉียบพลัน",
            "A083": "โรคอุจจาระร่วงเฉียบพลัน",
            "A084": "โรคอุจจาระร่วงเฉียบพลัน",
            "A085": "โรคอุจจาระร่วงเฉียบพลัน",
            "A090": "โรคอุจจาระร่วงเฉียบพลัน",
            "A099": "โรคอุจจาระร่วงเฉียบพลัน",
            "A09": "โรคอุจจาระร่วงเฉียบพลัน",
            "A08": "โรคอุจจาระร่วงเฉียบพลัน",
            "A04": "โรคอุจจาระร่วงเฉียบพลัน",

            "A010": "ไข้ไทฟอยด์",
            "A039": "โรคบิดจากเชื้อชิเกลลา",

            "A061": "โรคติดเชื้ออะมีบา",
            "A062": "โรคติดเชื้ออะมีบา",
            "A063": "โรคติดเชื้ออะมีบา",
            "A064": "โรคติดเชื้ออะมีบา",
            "A065": "โรคติดเชื้ออะมีบา",
            "A066": "โรคติดเชื้ออะมีบา",
            "A067": "โรคติดเชื้ออะมีบา",
            "A068": "โรคติดเชื้ออะมีบา",

            // --- โรคไข้เลือดออก ---
            "A90": "ไข้เลือดออก (DF,DHF,DSS)",
            "A91": "ไข้เลือดออก (DF,DHF,DSS)",
            "A910": "ไข้เลือดออก (DF,DHF,DSS)",
            "A911": "ไข้เลือดออก (DF,DHF,DSS)",
            "A970": "ไข้เลือดออก (DF,DHF,DSS)",
            "A971": "ไข้เลือดออก (DF,DHF,DSS)",
            "A972": "ไข้เลือดออก (DF,DHF,DSS)",
            "A979": "ไข้เลือดออก (DF,DHF,DSS)",

            // --- โรคติดเชื้ออื่นๆ ---
            "A241": "เมลิออยโดซิส",
            "A242": "เมลิออยโดซิส",
            "A243": "เมลิออยโดซิส",
            "A244": "เมลิออยโดซิส",

            "A270": "โรคเลปโตสไปโรซิส",
            "A278": "โรคเลปโตสไปโรซิส",
            "A279": "โรคเลปโตสไปโรซิส",

            "A302": "โรคเรื้อน",
            "A408": "การติดเชื้อสเตร็ปโดค็อกคัส",

            "A500": "ซิฟิลิส",
            "A502": "ซิฟิลิส",
            "A509": "ซิฟิลิส",
            "A510": "ซิฟิลิส",
            "A511": "ซิฟิลิส",
            "A513": "ซิฟิลิส",
            "A514": "ซิฟิลิส",
            "A519": "ซิฟิลิส",
            "A515": "ซิฟิลิส",
            "A521": "ซิฟิลิส",
            "A523": "ซิฟิลิส",
            "A527": "ซิฟิลิส",
            "A528": "ซิฟิลิส",
            "A529": "ซิฟิลิส",
            "A530": "ซิฟิลิส",
            "A539": "ซิฟิลิส",
            "O981": "ซิฟิลิส",
            "A54": "หนองใน",
            "A55": "กามโรคของต่อมและท่อน้ำเหลืองจากเชื้อคลามัยเดีย",
            "A57": "โรคแผลริมอ่อน (Chancroid)",
            "A60": "เริม (Chancroid)",
            "A630": "หูด",
            "A750": "สครับไทฟัส (Scrub typhus)",
            "A753": "สครับไทฟัส (Scrub typhus)",
            "A84": "อักเสบในสมองและเยื่อหุ้มสมอง)",
            "A85": "อักเสบในสมองและเยื่อหุ้มสมอง)",
            "A86": "อักเสบในสมองและเยื่อหุ้มสมอง)",
            "B004": "อักเสบในสมองและเยื่อหุ้มสมอง)",
            "B01": "อีสุกอีใส (Varicella [chickenpox])",
            "B05": "หัด (Measles [Morbilli])",
            "B084": "โรคมือ เท้า และปาก (Hand, Foot and Mouth Disease - HFMD)",
            "B085": "โรคมือ เท้า และปาก (Hand, Foot and Mouth Disease - HFMD)",
            "B150": "ตับอักเสบ เอ",
            "B16": "ตับอักเสบ บี",
            "B17": "ตับอักเสบจากไวรัสเฉียบพลันอื่น (Other acute viral hepatitis)",
            "B26": "โรคคางทูม (Mumps)",
            "B34": "การติดเชื้อไวรัสที่ไม่ระบุตำแหน่ง (Viral infection of unspecified site)",
            "B660": "Opisthorchiasis (โรคพยาธิใบไม้ตับโอปิสทอร์คิส))",
            "G009": "เยื่อหุ้มสมองอักเสบ",
            "G03": "เยื่อหุ้มสมองอักเสบ",
            "G04": "เยื่อหุ้มสมองอักเสบ",
            "G37": "เยื่อหุ้มสมองอักเสบ",
            "G58": "เยื่อหุ้มสมองอักเสบ",
            "G61": "เยื่อหุ้มสมองอักเสบ",
            "G62": "เยื่อหุ้มสมองอักเสบ",
            "G70": "เยื่อหุ้มสมองอักเสบ",
            "G72": "เยื่อหุ้มสมองอักเสบ",
            "G80": "เยื่อหุ้มสมองอักเสบ",
            "G81": "เยื่อหุ้มสมองอักเสบ",
            "G82": "เยื่อหุ้มสมองอักเสบ",
            "G95": "เยื่อหุ้มสมองอักเสบ",
            "J11": "ไข้หวัดใหญ่ (Influenza, virus not identified)",
            "J12": "ปอดบวม",
            "J15": "ปอดบวม",
            "J16": "ปอดบวม",
            "J18": "ปอดบวม",
            "J14": "ปอดบวม",
            "J851": "ปอดบวม",
            "M79": "ความผิดปกติของเนื้อเยื่ออ่อนอื่น ๆ",
            "R508": "ไข้ระบุรายละเอียดอื่น",
            "R509": "ไข้ระบุรายละเอียดอื่น",
            "R53": "ไข้ระบุรายละเอียดอื่น",
            "T620": "พิษจากเห็ด (Mushroom poisoning)",
            "U071": "โรคติดเชื้อไวรัสโคโรนา 2019 (COVID-19)",
            "U072": "โรคติดเชื้อไวรัสโคโรนา 2019 (COVID-19)",
            "AFP": "Acute Flaccid Paralysis (AFP)",
            "B34": "การติดเชื้อไวรัสที่ไม่ระบุตำแหน่ง (Viral infection of unspecified site)",
            "B34": "การติดเชื้อไวรัสที่ไม่ระบุตำแหน่ง (Viral infection of unspecified site)",
            "B34": "การติดเชื้อไวรัสที่ไม่ระบุตำแหน่ง (Viral infection of unspecified site)",
            "B34": "การติดเชื้อไวรัสที่ไม่ระบุตำแหน่ง (Viral infection of unspecified site)",
            "B34": "การติดเชื้อไวรัสที่ไม่ระบุตำแหน่ง (Viral infection of unspecified site)",
            "B34": "การติดเชื้อไวรัสที่ไม่ระบุตำแหน่ง (Viral infection of unspecified site)",
            "B34": "การติดเชื้อไวรัสที่ไม่ระบุตำแหน่ง (Viral infection of unspecified site)",
            "B34": "การติดเชื้อไวรัสที่ไม่ระบุตำแหน่ง (Viral infection of unspecified site)",
            "B34": "การติดเชื้อไวรัสที่ไม่ระบุตำแหน่ง (Viral infection of unspecified site)",




            // --- โรคระบบทางเดินหายใจ ---
            "J10": "ไข้หวัดใหญ่ (Influenza)",

            // --- โรคไม่ติดต่อและอื่นๆ ---
            "B18": "ไวรัสตับอักเสบบีเรื้อรัง", 
            "I10": "ความดันโลหิตสูง (Primary)",
            "E11": "เบาหวานชนิดที่ 2", 
            "Z00": "การตรวจสุขภาพทั่วไป"
        };
        
        /**
         * Converts an ICD-10 code to its primary disease group.
         */
        function classifyICD(icdCode) {
            if (!icdCode || typeof icdCode !== 'string') return 'ไม่ระบุ ICD';
            
            // 1. Clean the code: remove dots, etc., and get prefixes
            const cleanedCode = icdCode.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
            const fourDigitPrefix = cleanedCode.substring(0, 4);
            const threeDigitPrefix = cleanedCode.substring(0, 3);

            // 2. Look up using 4-digit code first, then fall back to 3-digit for broader categories
            return ICD_CODE_GROUPING[fourDigitPrefix] 
                || ICD_CODE_GROUPING[threeDigitPrefix] 
                || `ICD: ${fourDigitPrefix} (อื่นๆ)`;
        }

        /**
         * Province Code to Name Mapping (77 provinces)
         */
        const PROVINCE_CODE_TO_NAME_MAP = {
            "10": "กรุงเทพมหานคร", "11": "สมุทรปราการ", "12": "นนทบุรี", "13": "ปทุมธานี", "14": "พระนครศรีอยุธยา", "15": "อ่างทอง", "16": "ลพบุรี", "17": "สิงห์บุรี", "18": "ชัยนาท", "19": "สระบุรี", "20": "ชลบุรี", "21": "ระยอง", "22": "จันทบุรี", "23": "ตราด", "24": "ฉะเชิงเทรา", "25": "ปราจีนบุรี", "26": "นครนายก", "27": "สระแก้ว", "30": "นครราชสีมา", "31": "บุรีรัมย์", "32": "สุรินทร์", "33": "ศรีสะเกษ", "34": "อุบลราชธานี", "35": "ยโสธร", "36": "ชัยภูมิ", "37": "อำนาจเจริญ", "38": "บึงกาฬ", "39": "หนองบัวลำภู", "40": "ขอนแก่น", "41": "อุดรธานี", "42": "เลย", "43": "มหาสารคาม", "44": "ร้อยเอ็ด", "45": "กาฬสินธุ์", "46": "สกลนคร", "47": "นครพนม", "48": "มุกดาหาร", "49": "หนองคาย", "50": "เชียงใหม่", "51": "ลำพูน", "52": "ลำปาง", "53": "อุตรดิตถ์", "54": "แพร่", "55": "น่าน", "56": "พะเยา", "57": "เชียงราย", "58": "แม่ฮ่องสอน", "60": "นครสวรรค์", "61": "อุทัยธานี", "62": "กำแพงเพชร", "63": "ตาก", "64": "สุโขทัย", "65": "พิษณุโลก", "66": "พิจิตร", "67": "เพชรบูรณ์", "70": "ราชบุรี", "71": "กาญจนบุรี", "72": "สุพรรณบุรี", "73": "นครปฐม", "74": "สมุทรสาคร", "75": "สมุทรสงคราม", "76": "เพชรบุรี", "77": "ประจวบคีรีขันธ์", "80": "นครศรีธรรมราช", "81": "กระบี่", "82": "พังงา", "83": "ภูเก็ต", "84": "สุราษฎร์ธานี", "85": "ระนอง", "86": "ชุมพร", "90": "สงขลา", "91": "สตูล", "92": "ตรัง", "93": "พัทลุง", "94": "ปัตตานี", "95": "ยะลา", "96": "นราธิวาส"
        };

        /**
         * District Code to Name Mapping (Sample)
         */
        const DISTRICT_CODE_TO_NAME_MAP = {
            "1001": "พระนคร", "1002": "ดุสิต", "1003": "หนองจอก", "1004": "บางรัก", "1005": "บางเขน", "1017": "ห้วยขวาง", "1018": "คลองสาน", "1031": "บางคอแหลม", "1036": "ดอนเมือง", "1039": "วัฒนา", "1101": "เมืองสมุทรปราการ", "1103": "บางพลี", "1201": "เมืองนนทบุรี", "1202": "บางกรวย", "1301": "เมืองปทุมธานี", "1303": "ธัญบุรี", "1401": "พระนครศรีอยุธยา", "1402": "ท่าเรือ", "2001": "เมืองชลบุรี", "2002": "บ้านบึง", "2003": "หนองใหญ่", "2005": "พานทอง", "2008": "เกาะสีชัง", "2101": "เมืองระยอง", "2102": "บ้านฉาง", "3001": "เมืองนครราชสีมา", "3002": "ครบุรี", "3005": "บ้านเหลื่อม", "3009": "โนนไทย", "3012": "บัวใหญ่", "3013": "ประทาย", "3301": "เมืองศรีสะเกษ", "3302": "ยางชุมน้อย", "3303": "กันทรารมย์", "3304": "กันทรลักษ์", "3305": "ขุขันธ์", "3306": "ไพรบึง", "3307": "ปรางค์กู่", "3308": "ขุนหาญ", "3309": "ราษีไศล", "3310": "อุทุมพรพิสัย", "3311": "บึงบูรพ์", "3312": "ห้วยทับทัน", "3313": "โนนคูณ", "3314": "ศรีรัตนะ", "3315": "น้ำเกลี้ยง", "3316": "วังหิน", "3317": "ภูสิงห์", "3318": "เมืองจันทร์", "3319": "เบญจลักษ์", "3320": "พยุห์", "3321": "โพธิ์ศรีสุวรรณ", "3322": "ศิลาลาด", "3401": "เมืองอุบลราชธานี", "3402": "ศรีเมืองใหม่", "4001": "เมืองขอนแก่น", "4002": "บ้านไผ่", "4101": "เมืองอุดรธานี", "4301": "เมืองมหาสารคาม", "4401": "เมืองร้อยเอ็ด", "4501": "เมืองกาฬสินธุ์", "5001": "เมืองเชียงใหม่", "5002": "จอมทอง", "5005": "ดอยสะเก็ด", "5006": "แม่แตง", "5301": "เมืองอุตรดิตถ์", "5701": "เมืองเชียงราย", "6501": "เมืองพิษณุโลก", "6701": "เมืองเพชรบูรณ์", "8301": "เมืองภูเก็ต", "8302": "กะทู้", "8303": "ถลาง", "9001": "เมืองสงขลา", "9005": "เทพา", "9011": "หาดใหญ่", "3601": "เมืองชัยภูมิ", "3603": "คอนสวรรค์", "3610": "ภูเขียว",
        };
        
        /**
         * SubDistrict Code to Name Mapping (Sample)
         */
        const SUBDISTRICT_CODE_TO_NAME_MAP = {
            // --- อ.เมืองศรีสะเกษ (3301) ---
            "330101": "เมืองเหนือ",
            "330102": "เมืองใต้",
            "330103": "คูซอด",
            "330104": "ซำ",
            "330105": "จาน",
            "330106": "ตะดอบ",
            "330107": "หนองครก",
            "330111": "โพนข่า",
            "330112": "โพนค้อ",
            "330115": "โพนเขวา",
            "330116": "หญ้าปล้อง",
            "330118": "ทุ่ม",
            "330119": "หนองไฮ",
            "330121": "หนองแก้ว", 
            "330122": "น้ำคำ", 
            "330123": "โพธิ์", 
            "330124": "หมากเขียบ", 
            "330127": "หนองไผ่", 
            "330100": "ไม่ทราบที่อยู่",
            "330108": "ไม่ทราบที่อยู่",
            "330109": "ไม่ทราบที่อยู่",
            "330110": "ไม่ทราบที่อยู่",
            "330113": "ไม่ทราบที่อยู่",
            "330114": "ไม่ทราบที่อยู่",
            "330125": "ไม่ทราบที่อยู่",

            // --- Other Districts ---
            "100401": "สามเสนใน", "101701": "ห้วยขวาง", "101802": "หัวหมาก", "103101": "ดินแดง", "103601": "สีกัน", "103901": "บางนาเหนือ", "120101": "ตลาดขวัญ", "130303": "ลำผักกูด", "140101": "ประตูชัย", "200104": "บ้านสวน", "200201": "หนองปรือ", "200507": "นาจอมเทียน", "200801": "ศรีราชา", "210103": "มาบตาพุด", "300101": "ในเมือง (โคราช)", "300503": "ใหม่", "300901": "ในเมือง (พิมาย)", "301207": "กลางดง", "500108": "สุเทพ", "500109": "ช้างคลาน", "500502": "หนองหาร", "500602": "ริมใต้", "830101": "ตลาดใหญ่", "830202": "ป่าตอง", "830301": "เทพกระษัตรี", "900501": "ทำเนียบ", "901103": "ควนลัง", "100101": "พระบรมมหาราชวัง", "100201": "ดุสิต", "100301": "กระทุ่มราย", "110101": "ปากน้ำ", "110102": "สำโรงเหนือ", "120201": "วัดชลอ", "130101": "บางปรอก", "130301": "ประชาธิปัตย์", "150101": "ตลาดหลวง", "160101": "ทะเลชุบศร", "170101": "บางพุทรา", "180101": "ในเมือง (ชัยนาท)", "190101": "ปากเพรียว", "200101": "บางปลาสร้อย", "220101": "ตลาด", "230101": "บางพระ", "240101": "หน้าเมือง", "250101": "หน้าเมือง", "260101": "นครนายก", "270101": "สระแก้ว", "310101": "ในเมือง (บุรีรัมย์)", "320101": "ในเมือง (สุรินทร์)", "340101": "ในเมือง (อุบลฯ)", "350101": "ในเมือง (ยโสธร)", "360101": "ในเมือง (ชัยภูมิ)", "370101": "บุ่ง (อ.เจริญ)", "400101": "ในเมือง (ขอนแก่น)", "410101": "หมากแข้ง", "420101": "กุดป่อง", "430101": "ในเมือง (หนองคาย)", "440101": "ตลาด (มค.)", "450101": "ในเมือง (ร้อยเอ็ด)", "460101": "กาฬสินธุ์", "470101": "ธาตุเชิงชุม", "480101": "ในเมือง (นพ.)", "490101": "มุกดาหาร", "500101": "ศรีภูมิ", "510101": "ในเมือง (ลำพูน)", "520101": "เวียงเหนือ", "530101": "ท่าอิฐ", "540101": "ในเวียง", "550101": "ในเวียง", "560101": "เวียง (พะเยา)", "570101": "เวียง (ชร.)", "580101": "จองคำ", "600101": "ปากน้ำโพ", "610101": "อุทัยใหม่", "620101": "ในเมือง (กพ.)", "630101": "ระแหง", "640101": "ธานี", "650101": "ในเมือง (พล.)", "660101": "ในเมือง (พิจิตร)", "670101": "ในเมือง (พช.)", "700101": "หน้าเมือง", "710101": "บ้านเหนือ", "720101": "ท่าพี่เลี้ยง", "730101": "พระปฐมเจดีย์", "740101": "มหาชัย", "750101": "แม่กลอง", "760101": "ท่าราบ", "770101": "ประจวบคีรีขันธ์", "800101": "ในเมือง (นศ.)", "810101": "ปากน้ำ", "820101": "ท้ายช้าง", "830101": "ตลาดใหญ", "840101": "ตลาด (สฎ.)", "850101": "เขานิเวศน์", "860101": "ท่าตะเภา", "900101": "บ่อยาง", "910101": "พิมาน", "920101": "ทับเที่ยง", "930101": "คูหาสวรรค์", "940101": "สะบารัง", "950101": "สะเตง", "960101": "บางนาค"
        };
        
        /**
         * Parses CSV text into an array of objects.
         */
        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];
            
            const headers = lines[0].split(',').map(header => header.trim());
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(value => value.trim());
                if (values.length !== headers.length) continue; 
                
                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    const key = headers[j].replace(/\s/g, '_'); 
                    obj[key] = values[j];
                }
                result.push(obj);
            }
            return result;
        }
        
        /**
         * Parses a date string (DD/MM/YY or DD/MM/YYYY) into YYYY-MM-DD format.
         */
        function parseDate(dateString) {
            if (!dateString) return null;
            const parts = dateString.split(/[\/\-]/);
            
            if (parts.length === 3) {
                let [day, month, year] = parts;
                
                if (year.length === 2) {
                    year = (parseInt(year, 10) < 50 ? '20' : '19') + year;
                }
                
                month = month.padStart(2, '0');
                day = day.padStart(2, '0');

                return `${year}-${month}-${day}`;
            }
            return dateString;
        }


        /**
         * FIX: Refactored age classification for better clarity and correctness.
         * This function now uses a simple if-else structure to avoid ambiguity.
         */
        function classifyAge(age) {
            const ageNum = parseInt(age);
            if (isNaN(ageNum) || ageNum < 0) return 'ไม่ระบุ';
            
            if (ageNum <= 10) return '0-10 ปี';
            if (ageNum <= 20) return '11-20 ปี';
            if (ageNum <= 30) return '21-30 ปี';
            if (ageNum <= 40) return '31-40 ปี';
            if (ageNum <= 50) return '41-50 ปี';
            if (ageNum <= 60) return '51-60 ปี';
            if (ageNum <= 70) return '61-70 ปี';
            return '71 ปีขึ้นไป';
        }

        /**
         * Enriches line list data with proper geographic codes and display names.
         */
        function standardizeGeoData(lineList) {
            return lineList.map(item => {
                
                // Helper function for code lookup and display name assignment
                const convertCodeToName = (rawCode, map, length) => {
                    const code = rawCode ? rawCode.trim() : '';
                    const defaultCode = '0'.repeat(length);
                    
                    if (code && !isNaN(code) && (code.length === length || code.length === 2 && length === 4)) { 
                        const displayName = map[code];
                        return { 
                            code: code, 
                            displayName: displayName || `รหัส: ${code}` 
                        };
                    }
                    return { 
                        code: defaultCode, 
                        displayName: rawCode || 'ไม่ระบุ' 
                    };
                };

                // 1. Process Province (2-digit code)
                const provinceData = convertCodeToName(item.province, PROVINCE_CODE_TO_NAME_MAP, 2);
                item.provinceCode = provinceData.code;
                item.provinceDisplay = provinceData.displayName; 

                // 2. Process District (4-digit code), handling 2-digit inputs
                let rawDistrictCode = item.district ? item.district.trim() : '';
                let finalDistrictCode = rawDistrictCode;
                if (rawDistrictCode && !isNaN(rawDistrictCode) && rawDistrictCode.length === 2 && item.provinceCode.length === 2) {
                    finalDistrictCode = item.provinceCode + rawDistrictCode;
                } 
                const districtData = convertCodeToName(finalDistrictCode, DISTRICT_CODE_TO_NAME_MAP, 4);
                item.districtCode = districtData.code;
                item.districtDisplay = districtData.displayName; 

                // 3. Process SubDistrict (6-digit code), handling 2-digit inputs
                let rawSubDistrictCode = item.subDistrict ? item.subDistrict.trim() : '';
                let finalSubDistrictCode = rawSubDistrictCode;
                if (rawSubDistrictCode && !isNaN(rawSubDistrictCode) && rawSubDistrictCode.length === 2 && item.districtCode.length === 4) {
                    finalSubDistrictCode = item.districtCode + rawSubDistrictCode;
                }
                
                const subDistrictData = convertCodeToName(finalSubDistrictCode, SUBDISTRICT_CODE_TO_NAME_MAP, 6);
                item.subDistrictCode = subDistrictData.code;
                item.subDistrictDisplay = subDistrictData.displayName; 
                
                return item;
            });
        }


        /**
         * Fetches and processes epidemic data from the Google Sheet.
         */
        async function fetchEpidemicData() {
            let csvText = FALLBACK_CSV_TEXT;
            document.getElementById('loadingMessage').classList.remove('hidden');
            
            try {
                // Fetch with retry logic
                let response;
                for (let i = 0; i < 3; i++) { 
                    try {
                        response = await fetch(DAILY_DATA_URL);
                        if (response.ok) break; 
                    } catch (e) { /* Suppress error during retry */ }
                    if (i < 2) { 
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    }
                }
                
                if (!response || !response.ok) {
                    console.warn(`Fetch failed after retries. Using fallback data.`);
                } else {
                    csvText = await response.text();
                }
            } catch (networkError) {
                console.error("Error during fetch:", networkError);
                console.warn("Network error. Using fallback data.");
            } finally {
                document.getElementById('loadingMessage').classList.add('hidden');
            }

            try {
                const caseLineList = parseCSV(csvText);
                
                let formattedData = caseLineList.map(row => {
                    const ageGroup = classifyAge(row.Age);
                    const diseaseGroup = classifyICD(row.ICD_Code);

                    return {
                        reportDate: parseDate(row.Date),
                        disease: row.Disease || 'ไม่ระบุ', 
                        icdCode: row.ICD_Code || 'ไม่ระบุ ICD',
                        diseaseGroup: diseaseGroup,
                        sex: row.Sex || 'ไม่ระบุ',
                        ageGroup: ageGroup, 
                        nationality: row.Nationality || 'ไม่ระบุ',
                        province: row.Province || 'ไม่ระบุ',
                        district: row.District || 'ไม่ระบุ',
                        subDistrict: row.SubDistrict || 'ไม่ระบุ',
                        onsetDate: parseDate(row.Onset_Date),
                        patientType: row.PatientType || 'ไม่ระบุ', 
                        isDeath: parseInt(row.Is_Death) || 0,
                        isRecovered: parseInt(row.Is_Recovered) || 0,
                    };
                }).filter(item => item.reportDate);

                if (formattedData.length === 0 && caseLineList.length > 0) {
                    console.error("Data processing failed. Check column names in Google Sheet.");
                }
                
                return standardizeGeoData(formattedData);
            } catch (processingError) {
                console.error("A critical error occurred while processing data:", processingError);
                // Return an empty array to prevent the rest of the app from crashing.
                return [];
            }
        }

        /**
         * Filters the main dataset based on UI controls.
         */
        function filterData(lineList, startDate, endDate, selectedDisease, selectedProvince, selectedDistrict) {
            if (!lineList) return [];

            const start = new Date(startDate);
            const end = new Date(endDate);
            
            return lineList.filter(item => {
                const itemDate = new Date(item.reportDate);
                
                const startDay = new Date(start.setHours(0, 0, 0, 0));
                const endDay = new Date(end.setHours(23, 59, 59, 999));

                const isDateMatch = itemDate >= startDay && itemDate <= endDay;
                const isDiseaseMatch = selectedDisease === 'ทั้งหมด' || item.diseaseGroup === selectedDisease;
                const isProvinceMatch = selectedProvince === 'ทั้งหมด' || item.provinceDisplay === selectedProvince;
                const isDistrictMatch = selectedDistrict === 'ทั้งหมด' || item.districtDisplay === selectedDistrict;

                return isDateMatch && isDiseaseMatch && isProvinceMatch && isDistrictMatch;
            });
        }
        
        /**
         * Populates the province filter dropdown.
         */
        function populateProvinceFilters(data) {
            const allProvinces = [...new Set(data.map(item => item.provinceDisplay))].filter(Boolean).sort();
            
            selectInstances.province.clearOptions();
            selectInstances.province.addOption({value: 'ทั้งหมด', text: 'ทั้งหมด (All Provinces)'});
            allProvinces.forEach(province => {
                selectInstances.province.addOption({value: province, text: province});
            });
            selectInstances.province.setValue('ทั้งหมด');
            
            populateDistrictFilters(data); 
        }

        /**
         * Populates the district filter dropdown based on the selected province.
         */
        function populateDistrictFilters(data) {
            const selectedProvince = selectInstances.province.getValue();
            let districts = [];

            if (selectedProvince !== 'ทั้งหมด') {
                const filteredByProvince = data.filter(item => item.provinceDisplay === selectedProvince);
                districts = [...new Set(filteredByProvince.map(item => item.districtDisplay))].filter(Boolean).sort();
            }

            selectInstances.district.clear(); // This clears options and selection
            selectInstances.district.addOption({value: 'ทั้งหมด', text: 'ทั้งหมด (All Districts)'});
            districts.forEach(district => {
                selectInstances.district.addOption({value: district, text: district});
            });
            selectInstances.district.setValue('ทั้งหมด');
        }

        /**
         * Calculates and updates the key metric cards.
         */
        function calculateAndUpdateMetrics(filteredLineList) {
            const totalCases = filteredLineList.length;
            const totalDeaths = filteredLineList.reduce((sum, item) => sum + item.isDeath, 0);
            const totalRecovered = filteredLineList.reduce((sum, item) => sum + item.isRecovered, 0);
            const activeCases = totalCases - totalDeaths - totalRecovered; 

            document.getElementById('totalCases').textContent = totalCases.toLocaleString();
            document.getElementById('activeCases').textContent = activeCases.toLocaleString();
            document.getElementById('totalDeaths').textContent = totalDeaths.toLocaleString();
        }
        
        // --- CHART CREATION FUNCTIONS ---

        function destroyChart(chartId) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
                delete chartInstances[chartId];
            }
        }
        
        function createProvinceChart(data) {
            destroyChart('provinceChart');
            const provinceData = data.reduce((acc, curr) => {
                const key = curr.provinceDisplay || 'ไม่ระบุ'; 
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});

            const sortedProvinces = Object.entries(provinceData).filter(([name]) => name !== 'ไม่ระบุ').sort(([, a], [, b]) => b - a).slice(0, 10);
            const labels = sortedProvinces.map(([name]) => name);
            const cases = sortedProvinces.map(([, count]) => count);
            const ctx = document.getElementById('provinceChart').getContext('2d');
            
            chartInstances['provinceChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'ผู้ป่วยสะสม', data: cases, backgroundColor: '#10b981', borderColor: '#059669', borderWidth: 1, borderRadius: 6 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'จำนวนผู้ป่วยสะสม' }, beginAtZero: true, grid: { color: 'rgba(150, 150, 150, 0.1)' } }, y: { grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } } }
            });
        }
        
        function createDistrictChart(data) {
            destroyChart('districtChart');
            const districtData = data.reduce((acc, curr) => {
                const key = curr.districtDisplay || 'ไม่ระบุ'; 
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});

            const sortedDistricts = Object.entries(districtData).filter(([name]) => name !== 'ไม่ระบุ').sort(([, a], [, b]) => b - a).slice(0, 10);
            const labels = sortedDistricts.map(([name]) => name);
            const cases = sortedDistricts.map(([, count]) => count);
            const ctx = document.getElementById('districtChart').getContext('2d');
            
            const selectedProvince = selectInstances.province.getValue();
            const isVertical = selectedProvince !== 'ทั้งหมด';

            // Dynamic title update
            const chartTitleElement = document.getElementById('districtChartContainer').querySelector('h2');
            if (selectedProvince !== 'ทั้งหมด') {
                chartTitleElement.textContent = `10 อำเภอสูงสุด (จ.${selectedProvince})`;
            } else {
                chartTitleElement.textContent = '10 อำเภอที่มีผู้ป่วยสูงสุด';
            }

            const options = {
                indexAxis: isVertical ? 'x' : 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: isVertical ? { // Vertical scales
                    x: { grid: { display: false } },
                    y: { title: { display: true, text: 'จำนวนผู้ป่วยสะสม' }, beginAtZero: true, grid: { color: 'rgba(150, 150, 150, 0.1)' } }
                } : { // Horizontal scales
                    x: { title: { display: true, text: 'จำนวนผู้ป่วยสะสม' }, beginAtZero: true, grid: { color: 'rgba(150, 150, 150, 0.1)' } },
                    y: { grid: { display: false } }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { mode: 'index', intersect: false }
                }
            };

            chartInstances['districtChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'ผู้ป่วยสะสม', data: cases, backgroundColor: '#4f46e5', borderColor: '#3730a3', borderWidth: 1, borderRadius: 6 }]
                },
                options: options
            });
        }
        
        function createCasesTrendChart(data) {
            destroyChart('casesTrendChart');

            // 1. Group data by year, then by month using onsetDate
            const yearlyData = data.reduce((acc, curr) => {
                if (!curr.onsetDate) return acc; // Use onsetDate
                
                const date = new Date(curr.onsetDate); // Use onsetDate
                const year = date.getFullYear();
                const monthIndex = date.getMonth(); // 0-11

                if (!acc[year]) {
                    acc[year] = Array(12).fill(0); // Initialize an array of 12 zeros for the year
                }

                acc[year][monthIndex]++; // Increment the count for the specific month
                return acc;
            }, {});

            // 2. Define labels for the x-axis (12 months)
            const monthLabels = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
            
            // 3. Create a dataset for each year
            const years = Object.keys(yearlyData).sort();
            const lineColors = ['#4f46e5', '#ef4444', '#10b981', '#f59e0b', '#6b21a8', '#db2777']; // primary, danger, secondary, warning, purple, pink

            const datasets = years.map((year, index) => {
                const beYear = parseInt(year) + 543;
                const color = lineColors[index % lineColors.length];
                return {
                    label: `พ.ศ. ${beYear}`,
                    data: yearlyData[year],
                    borderColor: color,
                    backgroundColor: color + '1A', // semi-transparent
                    tension: 0.4,
                    fill: false // Best for multiple lines
                };
            });

            const ctx = document.getElementById('casesTrendChart').getContext('2d');
            
            chartInstances['casesTrendChart'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: datasets
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        x: { 
                            title: { display: true, text: 'เดือนที่รายงาน' }, 
                            grid: { display: false } 
                        }, 
                        y: { 
                            title: { display: true, text: 'จำนวนผู้ป่วยใหม่' }, 
                            beginAtZero: true, 
                            grid: { color: 'rgba(150, 150, 150, 0.1)' } 
                        } 
                    }, 
                    plugins: { 
                        legend: { 
                            position: 'top'
                        }, 
                        tooltip: { 
                            mode: 'index', 
                            intersect: false 
                        } 
                    } 
                }
            });
        }

        function createAgeDistributionChart(data) {
            destroyChart('ageDistributionChart');
            const ageData = data.reduce((acc, curr) => {
                const group = curr.ageGroup || 'ไม่ระบุ';
                acc[group] = (acc[group] || 0) + 1;
                return acc;
            }, {});

            // FIX: Updated sort order to match the refactored classifyAge function
            const ageOrder = ['0-10 ปี', '11-20 ปี', '21-30 ปี', '31-40 ปี', '41-50 ปี', '51-60 ปี', '61-70 ปี', '71 ปีขึ้นไป', 'ไม่ระบุ'];
            const sortedEntries = Object.entries(ageData).sort(([a], [b]) => ageOrder.indexOf(a) - ageOrder.indexOf(b));
            const labels = sortedEntries.map(([label]) => label);
            const cases = sortedEntries.map(([, count]) => count);
            const ctx = document.getElementById('ageDistributionChart').getContext('2d');
            
            chartInstances['ageDistributionChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'จำนวนผู้ป่วย', data: cases, backgroundColor: '#f59e0b', borderColor: '#d97706', borderWidth: 1, borderRadius: 6 }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'กลุ่มอายุ' }, grid: { display: false } }, y: { title: { display: true, text: 'จำนวนผู้ป่วย' }, beginAtZero: true, grid: { color: 'rgba(150, 150, 150, 0.1)' } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.parsed.y.toLocaleString()}` } } } }
            });
        }

        function createSexDistributionChart(data) {
            destroyChart('sexDistributionChart');
            const sexData = data.reduce((acc, curr) => {
                const sex = curr.sex || 'ไม่ระบุ';
                acc[sex] = (acc[sex] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(sexData);
            const cases = Object.values(sexData);
            const ctx = document.getElementById('sexDistributionChart').getContext('2d');

            chartInstances['sexDistributionChart'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{ label: 'จำนวนผู้ป่วย', data: cases, backgroundColor: ['#4f46e5', '#ef4444', '#94a3b8'], hoverOffset: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }, tooltip: { callbacks: { label: (c) => `${c.label}: ${c.parsed.toLocaleString()}` } } } }
            });
        }

        function createSubDistrictChart(data) {
            destroyChart('subDistrictChart');
            const subDistrictData = data.reduce((acc, curr) => {
                const key = curr.subDistrictDisplay || 'ไม่ระบุ'; 
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});

            const selectedProvince = selectInstances.province.getValue();
            const selectedDistrict = selectInstances.district.getValue();
            const chartTitleElement = document.getElementById('subDistrictChart').closest('.bg-white').querySelector('h2');
            let sortedSubDistricts;

            if (selectedDistrict !== 'ทั้งหมด') {
                // When a specific district is selected, show all its sub-districts alphabetically
                chartTitleElement.textContent = `จำนวนผู้ป่วยรายตำบล (อ.${selectedDistrict})`;
                sortedSubDistricts = Object.entries(subDistrictData)
                    .filter(([name]) => name !== 'ไม่ระบุ')
                    .sort(([a], [b]) => a.localeCompare(b, 'th'));
            } else if (selectedProvince !== 'ทั้งหมด') {
                 // When a province is selected (but not a district)
                chartTitleElement.textContent = `10 ตำบลสูงสุด (จ.${selectedProvince})`;
                sortedSubDistricts = Object.entries(subDistrictData)
                    .filter(([name]) => name !== 'ไม่ระบุ')
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 10);
            } else {
                // When "All" is selected, show the top 10 overall
                chartTitleElement.textContent = '10 ตำบลที่มีผู้ป่วยสูงสุด';
                sortedSubDistricts = Object.entries(subDistrictData)
                    .filter(([name]) => name !== 'ไม่ระบุ')
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 10);
            }

            const labels = sortedSubDistricts.map(([name]) => name);
            const cases = sortedSubDistricts.map(([, count]) => count);
            const ctx = document.getElementById('subDistrictChart').getContext('2d');
            
            chartInstances['subDistrictChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'ผู้ป่วยสะสม', data: cases, backgroundColor: '#ef4444', borderColor: '#dc2626', borderWidth: 1, borderRadius: 6 }]
                },
                options: { 
                    indexAxis: 'x', // Changed to 'x' for vertical bar chart
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        x: { // x-axis is now the category (sub-district)
                           grid: { display: false } 
                        }, 
                        y: { // y-axis is now the value (number of cases)
                           title: { display: true, text: 'จำนวนผู้ป่วยสะสม' }, 
                           beginAtZero: true, 
                           grid: { color: 'rgba(150, 150, 150, 0.1)' } 
                        } 
                    }, 
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { mode: 'index', intersect: false } 
                    } 
                }
            });
        }

        function createPatientTypeChart(data) {
            destroyChart('patientTypeChart');
            const typeData = data.reduce((acc, curr) => {
                const type = curr.patientType || 'ไม่ระบุ';
                acc[type] = (acc[type] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(typeData);
            const cases = Object.values(typeData);
            const ctx = document.getElementById('patientTypeChart').getContext('2d');

            chartInstances['patientTypeChart'] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{ label: 'จำนวนผู้ป่วย', data: cases, backgroundColor: ['#10b981', '#4f46e5', '#94a3b8'], hoverOffset: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }, tooltip: { callbacks: { label: (c) => `${c.label}: ${c.parsed.toLocaleString()}` } } } }
            });
        }

        // --- UI AND APP LOGIC ---

        let currentPage = 'overview';
        function showPage(pageId) {
            currentPage = pageId;
            document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(tab => {
                tab.classList.remove('border-primary', 'text-primary', 'dark:border-indigo-400', 'dark:text-indigo-400');
                tab.classList.add('border-transparent', 'text-gray-600', 'dark:text-gray-400');
            });

            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            const activeTab = document.getElementById(`tab-${pageId}`);
            if (activeTab) {
                activeTab.classList.remove('border-transparent', 'text-gray-600', 'dark:text-gray-400');
                activeTab.classList.add('border-primary', 'text-primary', 'dark:border-indigo-400', 'dark:text-indigo-400');
            }
            renderDashboard(); // Re-render to ensure charts are sized correctly on the active page
        }

        /**
         * Main function to re-render the dashboard on any filter change.
         */
        function renderDashboard() {
            const filteredData = filterData(
                epidemicData, 
                document.getElementById('startDate').value, 
                document.getElementById('endDate').value,
                selectInstances.disease.getValue(),
                selectInstances.province.getValue(), 
                selectInstances.district.getValue()
            );
            
            calculateAndUpdateMetrics(filteredData);
            createCasesTrendChart(filteredData);
            createAgeDistributionChart(filteredData);
            createSexDistributionChart(filteredData);
            createPatientTypeChart(filteredData);
            createProvinceChart(filteredData);
            createDistrictChart(filteredData); 
            createSubDistrictChart(filteredData); 

            // Handle visibility and layout for the Geo page charts
            const provinceChartContainer = document.getElementById('provinceChartContainer');
            const districtChartContainer = document.getElementById('districtChartContainer');
            const subDistrictChartContainer = document.getElementById('subDistrictChartContainer');

            if (provinceChartContainer && districtChartContainer && subDistrictChartContainer) {
                const selectedProvince = selectInstances.province.getValue();
                const selectedDistrict = selectInstances.district.getValue();

                if (currentPage === 'geographic') {
                    if (selectedDistrict !== 'ทั้งหมด') {
                        // District selected: show only sub-district, full width
                        provinceChartContainer.classList.add('hidden');
                        districtChartContainer.classList.add('hidden');
                        subDistrictChartContainer.classList.remove('hidden');
                        subDistrictChartContainer.classList.add('lg:col-span-2');
                    } else if (selectedProvince !== 'ทั้งหมด') {
                        // Province selected: show district and sub-district side-by-side
                        provinceChartContainer.classList.add('hidden');
                        districtChartContainer.classList.remove('hidden');
                        subDistrictChartContainer.classList.remove('hidden');
                        subDistrictChartContainer.classList.remove('lg:col-span-2');
                    } else {
                        // Default view (All, All): show province & district top, sub-district bottom
                        provinceChartContainer.classList.remove('hidden');
                        districtChartContainer.classList.remove('hidden');
                        subDistrictChartContainer.classList.remove('hidden');
                        subDistrictChartContainer.classList.add('lg:col-span-2');
                    }
                } else {
                    // Not on geo page, reset to default view to prevent layout bugs on return
                    provinceChartContainer.classList.remove('hidden');
                    districtChartContainer.classList.remove('hidden');
                    subDistrictChartContainer.classList.remove('hidden');
                    subDistrictChartContainer.classList.add('lg:col-span-2');
                }
            }

            // NEW: Update timestamp
            document.getElementById('lastUpdated').textContent = 'อัปเดตล่าสุด: ' + new Date().toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'short' });
        }

        /**
         * Initializes the application on window load.
         */
        window.onload = async function() {
            // NEW: Initialize searchable dropdowns first
            const tomSelectSettings = { create: false, sortField: { field: "text", direction: "asc" } };
            selectInstances.disease = new TomSelect('#diseaseFilter', tomSelectSettings);
            selectInstances.province = new TomSelect('#provinceFilter', tomSelectSettings);
            selectInstances.district = new TomSelect('#districtFilter', tomSelectSettings);

            epidemicData = await fetchEpidemicData(); 

            if (!epidemicData || epidemicData.length === 0) {
                console.error("Could not load or process line list data.");
            }

            const reportDates = epidemicData.map(item => item.reportDate).filter(Boolean).sort();
            const latestDate = reportDates.length > 0 ? reportDates[reportDates.length - 1] : new Date().toISOString().split('T')[0];
            const earliestDate = reportDates.length > 0 ? reportDates[0] : new Date().toISOString().split('T')[0];

            document.getElementById('startDate').value = earliestDate;
            document.getElementById('endDate').value = latestDate;

            // Populate disease filter using Tom Select API
            const allDiseaseGroups = [...new Set(epidemicData.map(item => item.diseaseGroup))].filter(Boolean).sort();
            selectInstances.disease.clearOptions();
            selectInstances.disease.addOption({value: 'ทั้งหมด', text: 'ทั้งหมด (All Diseases)'});
            allDiseaseGroups.forEach(group => {
                selectInstances.disease.addOption({value: group, text: group});
            });
            selectInstances.disease.setValue('ทั้งหมด');

            populateProvinceFilters(epidemicData);
            
            // --- Event Listeners ---
            const filterChangeHandler = () => renderDashboard(); 
            document.getElementById('startDate').addEventListener('change', filterChangeHandler);
            document.getElementById('endDate').addEventListener('change', filterChangeHandler);
            
            // Use Tom Select's change event
            selectInstances.disease.on('change', filterChangeHandler);
            selectInstances.district.on('change', filterChangeHandler);
            selectInstances.province.on('change', () => {
                populateDistrictFilters(epidemicData);
                renderDashboard();
            });

            // --- Theme Toggle Logic ---
            const themeToggleButton = document.getElementById('theme-toggle');
            const darkIcon = document.getElementById('theme-toggle-dark-icon');
            const lightIcon = document.getElementById('theme-toggle-light-icon');
            const isDark = () => document.documentElement.classList.contains('dark');
            const updateThemeIcons = () => {
                darkIcon.classList.toggle('hidden', isDark());
                lightIcon.classList.toggle('hidden', !isDark());
            };
            themeToggleButton.addEventListener('click', () => {
                const newTheme = isDark() ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                document.documentElement.classList.toggle('dark', newTheme === 'dark');
                updateThemeIcons();
                renderDashboard(); // Re-render charts with new theme colors if needed
            });
            updateThemeIcons();
            
            // Initial render
            showPage('overview');
        };
    </script>
</body>
</html>
